<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>함수형 연습</title>
    <script src="js/partial.js"></script>
    <script src="js/_.js"></script>
  </head>
  <body>
    <script>
      const users2 = [
        { id: 1, name: "ID", age: 30 },
        { id: 2, name: "BJ", age: 32 },
        { id: 3, name: "JM", age: 36 },
        { id: 4, name: "PJ", age: 10 },
        { id: 5, name: "HA", age: 15 },
        { id: 6, name: "JR", age: 18 },
        { id: 7, name: "JR", age: 18 },
        { id: 8, name: "JR1", age: 18 },
        { id: 20, name: "DH", age: 20 },
      ];

      /* curry가 적용된 add()를 실행하기 위해서는 add(1)(2)
       *  만약, add(1, 2) 이렇게 인자가 두 개 들어왔을 경우 즉시 실행되게 해줘야 함
       */

      function _curry(fn) {
        return function (a, b) {
          return arguments.length === 2
            ? fn(a, b)
            : function (b) {
                return fn(a, b);
              };
        };
      }

      const _curryr =
        (fn) =>
        (arg, ...args) => {
          return args.length ? fn(arg, ...args) : (...args) => fn(...args, arg);
        };

      const _get = _curryr((obj, key) => {
        return obj === null ? undefined : obj[key];
      });

      /* _get은 curry 적용해서 _get("name")(users2[0]) 이렇게 표현 가능
       * 결국 const getName = _get("name"),
       *     getName(users2[0]) 이렇게 함수로 만들 수 있음.
       */

      const _each = (list, iter) => {
        for (let i = 0; i < list.length; i++) {
          iter(list[i]);
        }
        return list;
      };

      const _filter = _curryr((list, predi) => {
        const newList = [];
        _each(list, (val) => {
          if (predi(val)) {
            newList.push(val);
          }
        });
        return newList;
      });

      const _map = _curryr((list, mapper) => {
        const newList = [];
        _each(list, (val) => {
          newList.push(mapper(val));
        });

        return newList;
      });

      const _rest = (list, number) => {
        const slice = Array.prototype.slice;
        return slice.call(list, number || 1);
      };

      const _reduce = (...args) => {
        let [list, iter, memo] = args;
        // 초기값 없는 경우
        if (args.length === 2) {
          memo = list[0];
          list = _rest(list);
        }
        _each(list, (val) => {
          memo = iter(memo, val);
        });
        return memo;
      };

      /* pipe는 함수를 인자로 받아서 함수를 연속적으로 사용
       *  함수를 리턴하는 함수가 pipe임 즉, pipe의 추상화 버전이 reduce
       */

      /* 함수 선언식 pipe */

      function _pipe(...args) {
        const fns = args;
        return function (arg) {
          return _reduce(
            fns,
            function (arg, fn) {
              return fn(arg);
            },
            arg
          );
        };
      }

      /* 화살표 pipe */

      /* go는 즉시 실행되는 파이프 함수 */

      const _go = (...args) => {
        // 아래는 _reduce와 동작 동일
        const fns = _rest(args);
        return _pipe.apply(null, fns)(args[0]);
      };

      // const result = _filter(users2, (user) => user.age > 30);
      // const result = _map(users2, _get("name"));
      // const result = _reduce([1, 2, 3], (a, b) => a + b, 0);

      // const result = _go(
      //   10,
      //   (a) => a + 1,
      //   (a) => a + 4,
      //   (a) => a - 10
      // );

      /* 아래의 형태는 curryr를 통해서 축약 가능 -> map, filter에 curryr 적용
       * ex) _map([1, 2, 3], (val) => val * 2)는 curryr 후
       *     _map((val) => val * 2)([1, 2, 3]) 이렇게 평가 순서 바꿀 수 있음
       */

      _go(
        users2,
        (users) =>
          _filter(users, (user) => {
            return user.age >= 30;
          }),
        (users) => _map(users, _get("name")),
        console.log
      );

      /* _curryr 적용 후 */

      _go(
        users2,
        _filter((user) => user.age > 30),
        _map(_get("name")),
        console.log
      );
    </script>
  </body>
</html>
